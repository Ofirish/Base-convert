<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base Converter By Ofir Wainstein</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Import Inter font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* General styling for the body */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased; /* Smoother font rendering */
            -moz-osx-font-smoothing: grayscale; /* Smoother font rendering */
        }

        /* Container for the entire application */
        .container {
            background: #fff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            transition: all 0.3s ease;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        /* New flex container for the header content */
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allows items to wrap to a new line on small screens */
        }

        header h1 {
            margin: 0;
            font-size: 2.2em;
            color: #1a1a1a;
        }

        /* Language selection buttons */
        .language-options {
            display: flex;
            gap: 5px; /* Adds spacing between the buttons */
        }

        .language-options button {
            background: none;
            border: 1px solid #ccc;
            color: #555;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
        }

        .language-options button:hover,
        .language-options button.active {
            background-color: #007bff;
            color: #fff;
            border-color: #007bff;
        }

        /* Main content layout */
        main {
            display: flex;
            flex-direction: column;
        }

        /* Group for input fields */
        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        select:focus {
            border-color: #007bff;
            outline: none;
        }

        .btn-primary {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .output-header h2,
        .explanation-section h3 {
            margin: 0;
            font-size: 1.4em;
            color: #1a1a1a;
        }

        .results-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            white-space: pre-wrap; /* Preserves whitespace and line breaks for formatted output */
            word-wrap: break-word;
            font-family: monospace; /* Use a monospaced font for code-like output */
            color: #343a40;
        }

        .action-buttons button {
            background: #e9ecef;
            border: none;
            color: #555;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 5px;
            transition: background-color 0.3s;
        }

        .action-buttons button:hover {
            background-color: #ced4da;
        }

        .action-buttons i {
            font-size: 1.1em;
        }

        .text-size-options {
            text-align: right;
            margin-top: 15px;
        }

        .text-size-options button {
            background: none;
            border: 1px solid #ccc;
            color: #555;
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
            transition: all 0.2s;
        }

        .text-size-options button#small-text { font-size: 0.8em; }
        .text-size-options button#medium-text { font-size: 1em; }
        .text-size-options button#large-text { font-size: 1.2em; }

        .text-size-options button.active {
            background-color: #007bff;
            color: #fff;
            border-color: #007bff;
        }

        /* Explanation section for detailed steps */
        .explanation-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .explanation-options {
            margin-top: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .explanation-options button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .explanation-options button:hover {
            background-color: #0056b3;
        }

        #explanation-content p {
            margin: 0 0 8px 0;
            padding-left: 10px;
            border-left: 3px solid #007bff;
        }

        #explanation-content p b {
            color: #0056b3;
        }

        .explanation-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #007bff;
            font-size: 1.2em;
        }

        /* Collapsible section for usage instructions */
        .explanation-container {
            margin-bottom: 20px;
        }

        .collapsible-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #ccc;
            transition: all 0.3s;
        }

        .collapsible-toggle:hover {
            color: #007bff;
            border-color: #007bff;
        }

        .collapsible-toggle.open {
            border-bottom-color: #007bff;
        }

        .collapsible-toggle.open i {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .collapsible-content.open {
            max-height: 500px; /* Adjust as needed, a large enough value to accommodate content */
        }

        /* Custom message box for alerts */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: #fff;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .message-box.show {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive design for mobile devices */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            .header-content {
                flex-direction: column;
                align-items: center;
                gap: 10px; /* Space between the title and buttons */
            }
            .header-content h1 {
                font-size: 1.8em;
            }
            .output-header {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            .action-buttons {
                margin-top: 5px;
            }
            .explanation-options {
                flex-direction: column;
                gap: 5px;
            }
            .explanation-options button {
                width: 100%;
            }
            .text-size-options {
                text-align: center;
            }
            .explanation-copy-buttons {
                flex-direction: column; /* Stack buttons vertically on small screens */
            }
        }

        /* Table styling for binary explanation */
        .binary-conversion-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .binary-conversion-table th,
        .binary-conversion-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }

        .binary-conversion-table th {
            background-color: #e9ecef;
            font-weight: bold;
        }

        .binary-conversion-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .explanation-copy-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .explanation-copy-buttons button {
            background-color: #6c757d; /* A secondary button color */
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .explanation-copy-buttons button:hover {
            background-color: #5a6268;
        }

        /* --- New/Modified styles for improved input UI/UX --- */

        /* Container for "Enter a number" and Clear button */
        .input-number-container {
            display: flex;
            flex-direction: column; /* Stack label and input/button */
            margin-bottom: 20px; /* Space before next input group */
        }

        .input-and-clear {
            display: flex;
            align-items: center; /* Vertically align input and button */
            gap: 10px; /* Space between input field and clear button */
            margin-top: 8px; /* Space below label */
        }

        .input-and-clear input[type="text"] {
            flex-grow: 1; /* Allow input to take remaining space */
            width: auto; /* Override default 100% width for flex behavior */
        }

        .clear-top-btn {
            background: #e9ecef;
            border: none;
            color: #555;
            padding: 12px; /* Consistent padding with input */
            border-radius: 8px; /* Consistent border-radius */
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent button from shrinking */
            /* Fixed height to match input for consistent alignment */
            height: 48px; /* Adjusted height to match common input field height with padding */
        }

        .clear-top-btn:hover {
            background-color: #ced4da;
        }

        /* Ensure Source Base dropdown also has consistent styling and spacing */
        .input-group select {
            margin-top: 8px; /* Consistent spacing after its label */
        }

        /* Specific styles for handling RTL layout */
        body[dir="rtl"] .input-and-clear {
            flex-direction: row-reverse; /* Reverse order for RTL to keep button on left */
        }

        /* Adjustments for mobile responsiveness */
        @media (max-width: 480px) {
            .input-and-clear {
                flex-direction: column; /* Stack input and button vertically on small screens */
                align-items: stretch; /* Make items stretch to full width */
                gap: 10px;
            }
            .input-and-clear input[type="text"],
            .clear-top-btn {
                width: 100%; /* Full width for better touch targets */
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Base Converter</h1>
                <div class="language-options">
                    <button id="lang-en" class="active">EN</button>
                    <button id="lang-he">HE</button>
                </div>
            </div>
        </header>

        <main>
            <div class="explanation-container">
                <h2 id="usage-toggle" class="collapsible-toggle">
                    Usage \ הוראות שימוש
                    <i class="fas fa-chevron-down"></i>
                </h2>
                <div id="usage-content" class="collapsible-content">
                    <p id="usage-text-en">
                        Welcome to the Base Converter by Ofir!
                        <br><br>
                        To use this tool, simply enter a number in the input box. Select its current base (Binary, Octal, Decimal, or Hexadecimal) from the "Source Base" dropdown. Click "Convert" to see the number converted to all other bases.
                        <br><br>
                        For a detailed, step-by-step breakdown of how the conversion works, click on one of the base buttons in the "Detailed Explanation" section that appears after conversion.
                        <br><br>
                        You can also switch between English and Hebrew using the language buttons.
                    </p>
                    <p id="usage-text-he" style="display: none;">
                        ברוכים הבאים לממיר הבסיסים!
                        <br><br>
                        כדי להשתמש בכלי, פשוט הזינו מספר בשדה הקלט. בחרו את הבסיס הנוכחי שלו (בינארי, אוקטלי, עשרוני או הקסדצימלי) מהרשימה "בסיס מקור". לחצו על "המר" כדי לראות את המספר מומר לכל הבסיסים האחרים.
                        <br><br>
                        להסבר מפורט, צעד אחר צעד, כיצד פועלת ההמרה, לחצו על אחד מכפתורי הבסיס בחלק "הסבר מפורט" שמופיע לאחר ההמרה.
                        <br><br>
                        ניתן גם לעבור בין אנגלית לעברית באמצעות כפתורי השפה.
                    </p>
                </div>
            </div>

            <div class="input-section">
                <!-- Grouping for "Enter a number" and Clear All button -->
                <div class="input-number-container">
                    <label for="input-number" id="label-number">Enter a number:</label>
                    <div class="input-and-clear">
                        <input type="text" id="input-number" placeholder="e.g., 10110">
                        <button id="clear-btn" class="clear-top-btn" title="Clear All"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>

                <!-- Original input-group for Source Base -->
                <div class="input-group">
                    <label for="from-base" id="label-from-base">Source Base:</label>
                    <select id="from-base">
                        <option value="2">Binary (2)</option>
                        <option value="8">Octal (8)</option>
                        <option value="10" selected>Decimal (10)</option>
                        <option value="16">Hexadecimal (16)</option>
                    </select>
                </div>
                <button id="convert-btn" class="btn-primary">Convert</button>
            </div>

            <div class="output-section">
                <div class="output-header">
                    <h2 id="output-title">Results:</h2>
                    <div class="action-buttons">
                        <button id="copy-btn" title="Copy to Clipboard"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
                <div class="results-box" id="results">
                </div>
                <div class="text-size-options">
                    <button id="small-text">A</button>
                    <button id="medium-text" class="active">A</button>
                    <button id="large-text">A</button>
                </div>
            </div>
            
            <div class="explanation-section" style="display: none;">
                <h3 id="explanation-title">Detailed Explanation</h3>
                <div class="explanation-options">
                    <button class="exp-btn" data-base="2">Binary</button>
                    <button class="exp-btn" data-base="8">Octal</button>
                    <button class="exp-btn" data-base="10">Decimal</button>
                    <button class="exp-btn" data-base="16">Hex</button>
                </div>
                <div id="explanation-content" class="results-box">
                </div>
                <div class="explanation-copy-buttons">
                    <button id="copy-explanation-btn"><i class="fas fa-copy"></i> <span id="copy-full-exp-text">Copy Full Explanation</span></button>
                    <button id="copy-csv-table-btn" style="display:none;"><i class="fas fa-table"></i> <span id="copy-csv-table-text">Copy Binary Table CSV</span></button>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom message box element -->
    <div id="message-box" class="message-box"></div>

    <script>
        // ====================================================================================
        // JavaScript functions adapted from the Python code
        // ====================================================================================

        /**
         * Converts a number from a given base to decimal (base 10).
         * @param {string} number - The number to convert.
         * @param {number} base - The source base (2, 8, 10, or 16).
         * @returns {number|null} The decimal value or null if the input is invalid.
         */
        function toDecimal(number, base) {
            let decimalValue = 0;
            // Reverse the digits to process from right to left, which corresponds to
            // increasing powers of the base (e.g., 10^0, 10^1, etc.).
            const digits = String(number).toUpperCase().split('').reverse();
            const digitsMap = "0123456789ABCDEF";

            for (let i = 0; i < digits.length; i++) {
                let digit = digits[i];
                let value;
                // Handle hexadecimal digits 'A' through 'F'
                if (base === 16 && 'A' <= digit && digit <= 'F') {
                    value = digitsMap.indexOf(digit);
                } else {
                    value = parseInt(digit);
                }
                // Check for invalid digits for the given base (e.g., a '2' in a binary number)
                if (isNaN(value) || value >= base) {
                    return null;
                }
                // Calculate the value of the current digit and add it to the total
                decimalValue += value * Math.pow(base, i);
            }
            return decimalValue;
        }

        /**
         * Converts a decimal number to a specified base.
         * @param {number} number - The decimal number to convert.
         * @param {number} base - The target base (2, 8, or 16).
         * @param {number|null} padToBits - Optional parameter to pad binary results with leading zeros.
         * @returns {string} The converted number as a string.
         */
        function fromDecimal(number, base, padToBits = null) {
            // Handle the special case where the number is 0
            if (number === 0) {
                return (padToBits && base === 2) ?
                    '0'.repeat(padToBits) : "0";
            }

            const digitsMap = "0123456789ABCDEF";
            let convertedNumber = "";
            let currentNumber = number;
            // Use repeated division and remainder to get the digits
            while (currentNumber > 0) {
                let remainder = currentNumber % base;
                // Prepend the new digit to the string to build the number in the correct order
                convertedNumber = digitsMap[remainder] + convertedNumber;
                currentNumber = Math.floor(currentNumber / base);
            }

            // Pad binary results if specified (e.g., for 8-bit representation)
            if (padToBits && base === 2) {
                return convertedNumber.padStart(padToBits, '0');
            }

            return convertedNumber;
        }

        // ====================================================================================
        // UI and Event Handlers
        // ====================================================================================

        // Object to store all multilingual text strings
        const langData = {
            en: {
                title: 'Base Converter',
                labelNumber: 'Enter a number:',
                labelFromBase: 'Source Base:',
                convertBtn: 'Convert',
                outputTitle: 'Results:',
                explanationTitle: 'Detailed Explanation',
                copySuccess: 'Copied to clipboard!',
                copyFail: 'Could not copy.',
                invalidNumber: 'Invalid number. Please check the digits for the selected base.',
                binary: 'Binary',
                octal: 'Octal',
                decimal: 'Decimal',
                hex: 'Hexadecimal',
                // Detailed explanation strings
                expToDecTitle: (num, base) => `✨ Converting '${num}' from base ${base} to decimal (base 10) ✨`,
                expToDecBody: (digit, pos, value, base, term) => `  Digit '${digit}' at position ${pos}: ${value} * (${base}^${pos}) = ${term}`,
                expFinalSum: (sum) => `  Final Sum: ${sum}`,
                expFromDecTitle: (num, base) => `✨ Converting '${num}' from decimal (base 10) to base ${base} ✨`,
                expFromDecBody: (current, base, next, rem, remDigit) => `  ${current} / ${base} = ${next} with a remainder of ${rem} (${remDigit})`,
                expReadRemainders: (result) => `  Reading remainders from bottom to top: ${result}`,
                expPaddedBinary: (result) => `  Padded to 8 bits: ${result}`,
                binaryTableTitle: (decimal) => `Binary Conversion Table for ${decimal}`,
                binaryTablePowers: (power) => `2^${power}`, // Plain text version for ASCII table
                copyFullExp: 'Copy Full Explanation', // New string for copy button
                copyCsvTable: 'Copy Binary Table CSV', // New string for CSV button
            },
            he: {
                title: 'ממיר בסיסים',
                labelNumber: 'הכנס מספר:',
                labelFromBase: 'בסיס מקור:',
                convertBtn: 'המר',
                outputTitle: 'תוצאות:',
                explanationTitle: 'הסבר מפורט',
                copySuccess: 'הועתק ללוח!',
                copyFail: 'העתקה נכשלה.',
                invalidNumber: 'מספר לא חוקי. אנא בדוק את הספרות עבור הבסיס שנבחר.',
                binary: 'בינארי',
                octal: 'אוקטלי',
                decimal: 'עשרוני',
                hex: 'הקסדצימלי',
                // Detailed explanation strings
                expToDecTitle: (num, base) => `✨ המרת '${num}' מבסיס ${base} לבסיס עשרוני (10) ✨`,
                expToDecBody: (digit, pos, value, base, term) => `  הספרה '${digit}' במיקום ${pos}: ${value} * (${base}^${pos}) = ${term}`,
                expFinalSum: (sum) => `  סיכום סופי: ${sum}`,
                expFromDecTitle: (num, base) => `✨ המרת '${num}' מבסיס עשרוני (10) לבסיס ${base} ✨`,
                expFromDecBody: (current, base, next, rem, remDigit) => `  ${current} / ${base} = ${next} עם שארית ${rem} (${remDigit})`,
                expReadRemainders: (result) => `  קריאת השאריות מלמטה למעלה: ${result}`,
                expPaddedBinary: (result) => `  מרופד ל-8 ביטים: ${result}`,
                binaryTableTitle: (decimal) => `טבלת המרה לבינארי עבור ${decimal}`,
                binaryTablePowers: (power) => `2^${power}`, // Plain text version for ASCII table
                copyFullExp: 'העתק הסבר מלא', // New string for copy button
                copyCsvTable: 'העתק טבלת בינארי כ-CSV', // New string for CSV button
            }
        };
        let currentLang = 'en';

        // Global variables to store the last explanation state for re-rendering
        let lastInputNumberForExplanation = '';
        let lastFromBaseForExplanation = 10;
        let lastToExplainBase = null; // Stores the data-base value of the last clicked explanation button

        // Global variables to hold the content for copying
        let currentPlainTextExplanation = '';
        let currentCsvTableData = null;

        // Get the message box element
        const messageBox = document.getElementById('message-box');

        /**
         * Displays a temporary message in a custom message box.
         * @param {string} message - The message to display.
         * @param {number} duration - The duration in milliseconds to display the message.
         */
        function showMessageBox(message, duration = 2000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        /**
         * Updates all UI text based on the current language setting.
         */
        function updateUI() {
            const data = langData[currentLang];
            document.title = data.title;
            document.querySelector('h1').textContent = data.title;
            document.getElementById('label-number').textContent = data.labelNumber;
            document.getElementById('label-from-base').textContent = data.labelFromBase;
            document.getElementById('convert-btn').textContent = data.convertBtn;
            document.getElementById('output-title').textContent = data.outputTitle;
            document.getElementById('explanation-title').textContent = data.explanationTitle;
            document.querySelector('.exp-btn[data-base="2"]').textContent = data.binary;
            document.querySelector('.exp-btn[data-base="8"]').textContent = data.octal;
            document.querySelector('.exp-btn[data-base="10"]').textContent = data.decimal;
            document.querySelector('.exp-btn[data-base="16"]').textContent = data.hex;

            // Update new copy button texts
            document.getElementById('copy-full-exp-text').textContent = data.copyFullExp;
            document.getElementById('copy-csv-table-text').textContent = data.copyCsvTable;


            // Show/hide usage instructions text based on language and adjust text direction
            if (currentLang === 'he') {
                document.body.style.direction = 'rtl';
                document.getElementById('usage-text-he').style.display = 'block';
                document.getElementById('usage-text-en').style.display = 'none';
            } else {
                document.body.style.direction = 'ltr';
                document.getElementById('usage-text-he').style.display = 'none';
                document.getElementById('usage-text-en').style.display = 'block';
            }

            // Re-generate the detailed explanation if it was previously displayed
            if (document.querySelector('.explanation-section').style.display === 'block' && lastToExplainBase !== null) {
                // Trigger generateExplanation directly with stored values
                generateExplanation(lastInputNumberForExplanation, lastFromBaseForExplanation, lastToExplainBase);
            }
        }

        // Attach event listeners when the document is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            updateUI();

            // Event listener for the "Convert" button
            document.getElementById('convert-btn').addEventListener('click', handleConversion);
            // Event listener for the "Clear" button (now at the top)
            document.getElementById('clear-btn').addEventListener('click', clearAll);
            // Event listener for the "Copy" button (for main results)
            document.getElementById('copy-btn').addEventListener('click', copyResults);
            // Event listener for "Copy Full Explanation" button
            document.getElementById('copy-explanation-btn').addEventListener('click', copyExplanationContents);
            // Event listener for "Copy Binary Table CSV" button
            document.getElementById('copy-csv-table-btn').addEventListener('click', copyBinaryTableAsCsv);


            // Event listeners for language buttons
            document.getElementById('lang-en').addEventListener('click', () => {
                currentLang = 'en';
                document.getElementById('lang-en').classList.add('active');
                document.getElementById('lang-he').classList.remove('active');
                updateUI(); // updateUI will now handle re-rendering the explanation
            });
            document.getElementById('lang-he').addEventListener('click', () => {
                currentLang = 'he';
                document.getElementById('lang-he').classList.add('active');
                document.getElementById('lang-en').classList.remove('active');
                updateUI(); // updateUI will now handle re-rendering the explanation
            });

            // Event listeners for text size buttons
            document.getElementById('small-text').addEventListener('click', () => {
                document.getElementById('results').style.fontSize = '0.9em';
                document.getElementById('explanation-content').style.fontSize = '0.9em';
                updateTextSizeButtons('small-text');
            });
            document.getElementById('medium-text').addEventListener('click', () => {
                document.getElementById('results').style.fontSize = '1em';
                document.getElementById('explanation-content').style.fontSize = '1em';
                updateTextSizeButtons('medium-text');
            });
            document.getElementById('large-text').addEventListener('click', () => {
                document.getElementById('results').style.fontSize = '1.2em';
                document.getElementById('explanation-content').style.fontSize = '1.2em';
                updateTextSizeButtons('large-text');
            });
            // Event listeners for explanation buttons
            document.querySelectorAll('.exp-btn').forEach(button => {
                button.addEventListener('click', handleExplanation);
            });
            // Event listener for the new collapsible usage section
            const usageToggle = document.getElementById('usage-toggle');
            const usageContent = document.getElementById('usage-content');
            usageToggle.addEventListener('click', () => {
                const isOpen = usageContent.classList.toggle('open');
                usageToggle.classList.toggle('open', isOpen);
            });
        });

        /**
         * Updates the active class on the text size buttons.
         * @param {string} activeId - The ID of the button to set as active.
         */
        function updateTextSizeButtons(activeId) {
            document.querySelectorAll('.text-size-options button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }

        /**
         * Handles the main conversion process.
         */
        function handleConversion() {
            const inputNumber = document.getElementById('input-number').value.trim();
            const fromBase = parseInt(document.getElementById('from-base').value);
            const resultsDiv = document.getElementById('results');
            const explanationSection = document.querySelector('.explanation-section');
            // Validate the input number using regex
            if (!validateInput(inputNumber, fromBase)) {
                resultsDiv.textContent = langData[currentLang].invalidNumber;
                explanationSection.style.display = 'none';
                return;
            }

            let decimalValue;
            // Handle case where source base is already decimal
            if (fromBase === 10) {
                decimalValue = parseInt(inputNumber);
            } else {
                decimalValue = toDecimal(inputNumber, fromBase);
            }

            if (decimalValue === null) {
                resultsDiv.textContent = langData[currentLang].invalidNumber;
                explanationSection.style.display = 'none';
                return;
            }

            // Perform conversions to other bases and format the output
            const binary = fromDecimal(decimalValue, 2, 8);
            const octal = fromDecimal(decimalValue, 8);
            const hex = fromDecimal(decimalValue, 16);
            const output = `
 Decimal: ${decimalValue}
 Binary:  ${binary}
 Octal:   ${octal}
 Hex:     ${hex}
            `;
            resultsDiv.textContent = output;
            explanationSection.style.display = 'block';
        }

        /**
         * Validates the input number based on the selected base using regex.
         * @param {string} number - The number string to validate.
         * @param {number} base - The base to validate against.
         * @returns {boolean} True if the input is valid, otherwise false.
         */
        function validateInput(number, base) {
            if (!number) return false;
            // Handle empty input or input that is just a sign
            if (number === '-' || number === '+') return false;

            switch (base) {
                case 2:
                    return /^[01]+$/.test(number);
                case 8:
                    return /^[0-7]+$/.test(number);
                case 10:
                    // Allow optional leading '+' or '-' for decimal
                    return /^-?[0-9]+$/.test(number);
                case 16:
                    return /^[0-9A-Fa-f]+$/.test(number);
                default:
                    return false;
            }
        }

        /**
         * Helper function to remove emojis from a string.
         * @param {string} str - The input string.
         * @returns {string} The string with emojis removed.
         */
        function removeEmojis(str) {
            // This regex matches various emoji categories
            const emojiRegex = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/g;
            return str.replace(emojiRegex, '');
        }

        /**
         * Generates and displays the detailed conversion explanation.
         * This function is now responsible for the core logic of explanation generation.
         * @param {string} inputNum - The input number string.
         * @param {number} srcBase - The source base.
         * @param {number} targetBase - The target base for explanation.
         */
        function generateExplanation(inputNum, srcBase, targetBase) {
            const explanationContent = document.getElementById('explanation-content');
            const explanationSection = document.querySelector('.explanation-section'); // Get the section element
            explanationContent.innerHTML = ''; // Clear previous content
            
            // Ensure the explanation section is visible when an explanation is generated
            explanationSection.style.display = 'block';

            // Hide CSV button by default
            document.getElementById('copy-csv-table-btn').style.display = 'none';
            currentCsvTableData = null; // Clear previous CSV data

            // Define digitsMap here to be accessible within this function's scope
            const digitsMap = "0123456789ABCDEF";

            if (!validateInput(inputNum, srcBase)) {
                explanationContent.textContent = langData[currentLang].invalidNumber;
                currentPlainTextExplanation = langData[currentLang].invalidNumber;
                return;
            }

            let decimalValue;
            if (srcBase === 10) {
                decimalValue = parseInt(inputNum);
            } else {
                decimalValue = toDecimal(inputNum, srcBase);
            }

            if (decimalValue === null) {
                explanationContent.textContent = langData[currentLang].invalidNumber;
                currentPlainTextExplanation = langData[currentLang].invalidNumber;
                return;
            }

            let explanationHTML = '';
            let plainTextContent = ''; // This will store the explanation WITHOUT the table for "Copy Full Explanation"
            const data = langData[currentLang]; 

            // Step 1: Conversion to Decimal (if source is not decimal)
            if (srcBase !== 10) {
                const titleHtml = data.expToDecTitle(inputNum, srcBase);
                explanationHTML += `<h4>${titleHtml}</h4>`;
                plainTextContent += removeEmojis(titleHtml) + '\n'; // Remove emojis for plain text

                const digits = String(inputNum).toUpperCase().split('').reverse();
                let sum = 0;
                for (let i = 0; i < digits.length; i++) {
                    const digit = digits[i];
                    let value;
                    if (srcBase === 16 && 'A' <= digit && digit <= 'F') {
                        value = digitsMap.indexOf(digit);
                    } else {
                        value = parseInt(digit);
                    }
                    const term = value * Math.pow(srcBase, i);
                    sum += term;
                    const bodyText = data.expToDecBody(digit, i, value, srcBase, term);
                    explanationHTML += `<p>${bodyText}</p>`;
                    plainTextContent += bodyText + '\n';
                }
                const finalSumText = data.expFinalSum(sum);
                explanationHTML += `<p><b>${finalSumText}</b></p>`;
                plainTextContent += finalSumText + '\n\n';
            }

            // Step 2: Conversion from Decimal (if target is not decimal or if source is decimal and target is binary)
            // This condition ensures the second part of explanation is always shown correctly
            // even if srcBase is 10 and target is 2 (e.g., Decimal to Binary)
            if (targetBase !== 10 || (srcBase === 10 && targetBase === 2)) {
                const titleHtml = data.expFromDecTitle(decimalValue, targetBase);
                explanationHTML += `<h4>${titleHtml}</h4>`;
                plainTextContent += removeEmojis(titleHtml) + '\n';

                let currentNumber = decimalValue;
                let steps = [];
                // Collect all division steps
                while (currentNumber > 0) {
                    const remainder = currentNumber % targetBase;
                    const nextNumber = Math.floor(currentNumber / targetBase);
                    steps.push({ current: currentNumber, next: nextNumber, remainder: remainder });
                    currentNumber = nextNumber;
                }
                if (decimalValue === 0) { // Special case for 0
                    steps.push({ current: 0, next: 0, remainder: 0 });
                }


                // Display the steps from top to bottom (larger number division to smaller)
                for(let i = 0; i < steps.length; i++) { // Loop from 0 to steps.length-1 for top-to-bottom
                    const step = steps[i];
                    const bodyText = data.expFromDecBody(step.current, targetBase, step.next, step.remainder, digitsMap[step.remainder]);
                    explanationHTML += `<p>${bodyText}</p>`;
                    plainTextContent += bodyText + '\n';
                }
                
                const finalResult = fromDecimal(decimalValue, targetBase);
                const readRemaindersText = data.expReadRemainders(finalResult); 
                explanationHTML += `<p><b>${readRemaindersText}</b></p>`;
                plainTextContent += readRemaindersText + '\n'; // Add to plain text content

                // Add binary conversion table if target base is Binary
                if (targetBase === 2) {
                    const paddedBinaryText = data.expPaddedBinary(fromDecimal(decimalValue, 2, 8));
                    explanationHTML += `<p><b>${paddedBinaryText}</b></p>`;
                    // Do NOT add paddedBinaryText to plainTextContent here for "Copy Full Explanation"
                    explanationHTML += `<h4>${data.binaryTableTitle(decimalValue)}</h4>`;
                    // Do NOT add binaryTableTitle to plainTextContent here for "Copy Full Explanation"

                    let tableHTML = '<table class="binary-conversion-table"><thead><tr>';
                    let powers = [];
                    let values = [];
                    let binaryDigits = [];

                    // Determine the highest power of 2 needed
                    let highestPower = 0;
                    if (decimalValue > 0) {
                        highestPower = Math.floor(Math.log2(decimalValue));
                    } else if (decimalValue === 0) {
                        highestPower = 0; // For 0, we still need 2^0 column
                    }
                    
                    // Generate powers and their values from highest to 0
                    for (let p = highestPower; p >= 0; p--) {
                        powers.push(p);
                        values.push(Math.pow(2, p));
                    }

                    // Populate table headers (powers of 2)
                    tableHTML += '<th></th>'; // Empty cell for the first column header
                    let csvTableHeaders = ['']; // CSV headers will still be generated
                    for (let p of powers) {
                        const powerHtml = data.binaryTablePowers(p);
                        tableHTML += `<th>${powerHtml}</th>`;
                        csvTableHeaders.push(`2^${p}`); // For CSV representation
                    }
                    tableHTML += '</tr></thead><tbody><tr>';

                    // Populate second row (decimal values of powers)
                    tableHTML += `<td>${decimalValue}</td>`; // Display decimal value for reference
                    let csvTableValues = [decimalValue.toString()]; // CSV values still generated
                    for (let val of values) {
                        tableHTML += `<td>${val}</td>`;
                        csvTableValues.push(val.toString());
                    }
                    tableHTML += '</tr><tr>';

                    // Populate third row (binary digits)
                    tableHTML += `<td></td>`; // Empty cell for the third row first column
                    let csvTableDigits = ['']; // CSV digits still generated
                    let tempDecimal = decimalValue;
                    for (let val of values) {
                        if (tempDecimal >= val) {
                            binaryDigits.push(1);
                            tempDecimal -= val;
                        } else {
                            binaryDigits.push(0);
                        }
                    }
                    for (let digit of binaryDigits) {
                        tableHTML += `<td>${digit}</td>`;
                        csvTableDigits.push(digit.toString());
                    }
                    tableHTML += '</tr></tbody></table>';
                    explanationHTML += tableHTML;

                    // The ASCII table generation for plainTextContent is now COMPLETELY REMOVED from generateExplanation
                    // to ensure it is not included in "Copy Full Explanation"

                    // Generate CSV table string (remains for CSV copy button)
                    currentCsvTableData = [
                        csvTableHeaders.join(','),
                        csvTableValues.join(','),
                        csvTableDigits.join(',')
                    ].join('\n');
                    
                    // Show CSV button when binary table is present
                    document.getElementById('copy-csv-table-btn').style.display = 'inline-block';
                }
            }
            
            // Handle the special case where the source and target bases are the same
            if (srcBase === targetBase && srcBase !== 10) {
                // This block re-generates explanation for non-decimal same-base conversions
                // to ensure consistency with the `if (srcBase !== 10)` and `if (targetBase !== 10)` blocks.
                explanationHTML = '';
                plainTextContent = ''; // Reset plainTextContent for this specific case

                // Part 1: Convert to Decimal
                const titleToDecHtml = data.expToDecTitle(inputNum, srcBase);
                explanationHTML += `<h4>${titleToDecHtml}</h4>`;
                plainTextContent += removeEmojis(titleToDecHtml) + '\n';

                const digits = String(inputNum).toUpperCase().split('').reverse();
                let sum = 0;
                for (let i = 0; i < digits.length; i++) {
                    const digit = digits[i];
                    let value;
                    if (srcBase === 16 && 'A' <= digit && digit <= 'F') {
                        value = digitsMap.indexOf(digit);
                    } else {
                        value = parseInt(digit);
                    }
                    const term = value * Math.pow(srcBase, i);
                    sum += term;
                    const bodyText = data.expToDecBody(digit, i, value, srcBase, term);
                    explanationHTML += `<p>${bodyText}</p>`;
                    plainTextContent += bodyText + '\n';
                }
                const finalSumText = data.expFinalSum(sum);
                explanationHTML += `<p><b>${finalSumText}</b></p>`;
                plainTextContent += finalSumText + '\n\n';

                // Part 2: Convert from Decimal to Same Base
                const titleFromDecHtml = data.expFromDecTitle(decimalValue, targetBase);
                explanationHTML += `<h4>${titleFromDecHtml}</h4>`;
                plainTextContent += removeEmojis(titleFromDecHtml) + '\n';

                let currentNumber = decimalValue;
                let steps = [];
                while (currentNumber > 0) {
                    const remainder = currentNumber % targetBase;
                    const nextNumber = Math.floor(currentNumber / targetBase);
                    steps.push({ current: currentNumber, next: nextNumber, remainder: remainder });
                    currentNumber = nextNumber;
                }
                if (decimalValue === 0) {
                    steps.push({ current: 0, next: 0, remainder: 0 });
                }
                
                for(let i = 0; i < steps.length; i++) {
                    const step = steps[i];
                    const bodyText = data.expFromDecBody(step.current, targetBase, step.next, step.remainder, digitsMap[step.remainder]);
                    explanationHTML += `<p>${bodyText}</p>`;
                    plainTextContent += bodyText + '\n';
                }
                const finalResult = fromDecimal(decimalValue, targetBase);
                const readRemaindersText = data.expReadRemainders(finalResult);
                explanationHTML += `<p><b>${readRemaindersText}</b></p>`;
                plainTextContent += readRemaindersText + '\n';

                if (targetBase === 2) {
                    const paddedBinaryText = data.expPaddedBinary(fromDecimal(decimalValue, 2, 8));
                    explanationHTML += `<p><b>${paddedBinaryText}</b></p>`;
                    // Do NOT add paddedBinaryText to plainTextContent here for "Copy Full Explanation"
                    explanationHTML += `<h4>${data.binaryTableTitle(decimalValue)}</h4>`;
                    // Do NOT add binaryTableTitle to plainTextContent here for "Copy Full Explanation"

                    let tableHTML = '<table class="binary-conversion-table"><thead><tr>';
                    let powers = [];
                    let values = [];
                    let binaryDigits = [];

                    let highestPower = 0;
                    if (decimalValue > 0) {
                        highestPower = Math.floor(Math.log2(decimalValue));
                    } else if (decimalValue === 0) {
                        highestPower = 0;
                    }
                    
                    for (let p = highestPower; p >= 0; p--) {
                        powers.push(p);
                        values.push(Math.pow(2, p));
                    }

                    tableHTML += '<th></th>';
                    let csvTableHeaders = [''];
                    for (let p of powers) {
                        const powerHtml = data.binaryTablePowers(p);
                        tableHTML += `<th>${powerHtml}</th>`;
                        csvTableHeaders.push(`2^${p}`);
                    }
                    tableHTML += '</tr></thead><tbody><tr>';

                    tableHTML += `<td>${decimalValue}</td>`;
                    let csvTableValues = [decimalValue.toString()];
                    for (let val of values) {
                        tableHTML += `<td>${val}</td>`;
                        csvTableValues.push(val.toString());
                    }
                    tableHTML += '</tr><tr>';

                    tableHTML += `<td></td>`;
                    let csvTableDigits = [''];
                    let tempDecimal = decimalValue;
                    for (let val of values) {
                        if (tempDecimal >= val) {
                            binaryDigits.push(1);
                            tempDecimal -= val;
                        } else {
                            binaryDigits.push(0);
                        }
                    }
                    for (let digit of binaryDigits) {
                        tableHTML += `<td>${digit}</td>`;
                        csvTableDigits.push(digit.toString());
                    }
                    tableHTML += '</tr></tbody></table>';
                    explanationHTML += tableHTML;

                    // The ASCII table generation for plainTextContent is now COMPLETELY REMOVED from generateExplanation
                    // to ensure it is not included in "Copy Full Explanation"

                    currentCsvTableData = [
                        csvTableHeaders.join(','),
                        csvTableValues.join(','),
                        csvTableDigits.join(',')
                    ].join('\n');
                    document.getElementById('copy-csv-table-btn').style.display = 'inline-block';
                }
            } else if (srcBase === targetBase && srcBase === 10) { // If both are decimal
                explanationHTML = `<p>The number ${inputNum} is already in base ${srcBase}.</p>`;
                plainTextContent = `The number ${inputNum} is already in base ${srcBase}.`;
            }

            explanationContent.innerHTML = explanationHTML;
            currentPlainTextExplanation = plainTextContent.trim(); // Trim extra newlines
        }

        // Modified handleExplanation to store state and then call the core generation function
        function handleExplanation(event) {
            const toBase = parseInt(event.target.dataset.base);
            const inputNumber = document.getElementById('input-number').value.trim();
            const fromBase = parseInt(document.getElementById('from-base').value);

            // Store the current values for later re-rendering on language change
            lastInputNumberForExplanation = inputNumber;
            lastFromBaseForExplanation = fromBase;
            lastToExplainBase = toBase;

            // Ensure the explanation section is visible here
            document.querySelector('.explanation-section').style.display = 'block';

            generateExplanation(inputNumber, fromBase, toBase);
        }

        /**
         * Clears all input and output fields.
         */
        function clearAll() {
            document.getElementById('input-number').value = '';
            document.getElementById('results').textContent = '';
            document.getElementById('explanation-content').innerHTML = '';
            document.querySelector('.explanation-section').style.display = 'none';
            // Hide CSV button and clear data
            document.getElementById('copy-csv-table-btn').style.display = 'none';
            currentPlainTextExplanation = '';
            currentCsvTableData = null;
            // Also clear the stored explanation state
            lastInputNumberForExplanation = '';
            lastFromBaseForExplanation = 10;
            lastToExplainBase = null;
        }

        /**
         * Copies the main results to the clipboard using document.execCommand.
         */
        function copyResults() {
            const resultsText = document.getElementById('results').textContent;
            if (resultsText) {
                const textarea = document.createElement('textarea');
                textarea.value = resultsText;
                textarea.style.position = 'fixed'; // Prevent scrolling to bottom of page
                textarea.style.opacity = 0; // Hide the textarea
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessageBox(langData[currentLang].copySuccess);
                } catch (err) {
                    showMessageBox(langData[currentLang].copyFail);
                }
                document.body.removeChild(textarea);
            }
        }

        /**
         * Copies the full detailed explanation content (plain text, no emojis, ASCII table) to the clipboard.
         */
        function copyExplanationContents() {
            if (currentPlainTextExplanation) {
                const textarea = document.createElement('textarea');
                textarea.value = currentPlainTextExplanation;
                textarea.style.position = 'fixed'; // Prevent scrolling to bottom of page
                textarea.style.opacity = 0; // Hide the textarea
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessageBox(langData[currentLang].copySuccess);
                } catch (err) {
                    showMessageBox(langData[currentLang].copyFail);
                }
                document.body.removeChild(textarea);
            } else {
                showMessageBox(langData[currentLang].copyFail);
            }
        }

        /**
         * Copies the binary conversion table data as CSV to the clipboard.
         */
        function copyBinaryTableAsCsv() {
            if (currentCsvTableData) {
                const textarea = document.createElement('textarea');
                textarea.value = currentCsvTableData;
                textarea.style.position = 'fixed'; // Prevent scrolling to bottom of page
                textarea.style.opacity = 0; // Hide the textarea
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessageBox(langData[currentLang].copySuccess);
                } catch (err) {
                    showMessageBox(langData[currentLang].copyFail);
                }
                document.body.removeChild(textarea);
            } else {
                showMessageBox(langData[currentLang].copyFail);
            }
        }
    </script>
</body>
</html>
